name: Test Suite

on:
  push:
    branches: [ main, vp/*, feature/* ]
  pull_request:
    branches: [ main ]

jobs:
  # E2E tests - comprehensive end-to-end testing
  e2e-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure Supabase IP allowlist FIRST
      run: |
        # Add ONLY the current runner IP using official Management API
        RUNNER_IP=$(curl -s https://ipinfo.io/ip)
        echo "Runner IP: $RUNNER_IP"
        
        # Get current network restrictions
        echo "Getting current restrictions..."
        CURRENT_RESTRICTIONS=$(curl -s -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
          "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/network-restrictions")
        echo "Current: $CURRENT_RESTRICTIONS"
        
        # Add runner IP to allowlist using official API
        echo "Adding runner IP to allowlist..."
        curl -X PUT "https://api.supabase.com/v1/projects/$SUPABASE_PROJECT_ID/network-restrictions" \
          -H "Authorization: Bearer $SUPABASE_ACCESS_TOKEN" \
          -H "Content-Type: application/json" \
          -d "{
            \"allowed_cidrs\": [\"${RUNNER_IP}/32\"]
          }"
        
        echo "âœ… Runner IP ${RUNNER_IP}/32 added to allowlist"
        
        # Wait a moment for the change to propagate
        sleep 5
      env:
        SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run E2E tests
      run: |
        python app/tests/test_runner.py
      env:
        # Database credentials for CI
        SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
        # Add any required environment variables for E2E tests
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }}
        OPEN_ROUTER_API_KEY: ${{ secrets.OPEN_ROUTER_API_KEY }}

  # Linting
  lint:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run linting
      run: |
        ./lint.sh